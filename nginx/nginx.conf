events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Geoip for location-based routing
    map $remote_addr $shop_region {
        default "us-east";
        ~^10\.1\..*$ "us-east";
        ~^10\.2\..*$ "us-west";
        ~^10\.3\..*$ "eu";
        ~^10\.4\..*$ "asia";
    }

    # GeoIP mapping for shop routing
    map $remote_addr $shop_cluster {
        default shops_us_east;
        ~^10\.0\.1\. shops_us_east;
        ~^10\.0\.2\. shops_us_west;
        ~^10\.0\.3\. shops_eu;
        ~^10\.0\.4\. shops_asia;
    }

    # Main platform upstream
    upstream main_platform {
        server main-platform:3000;
    }

    # Shop clusters by region
    upstream shops_us_east {
        server shop-us-east-1:3001;
        server shop-us-east-2:3001;
    }

    upstream shops_us_west {
        server shop-us-west-1:3002;
        server shop-us-west-2:3002;
    }

    upstream shops_eu {
        server shop-eu-1:3003;
        server shop-eu-2:3003;
    }

    upstream shops_asia {
        server shop-asia-1:3004;
        server shop-asia-2:3004;
    }

    # Industry service clusters
    upstream ecommerce_services {
        server ecommerce-service-1:4001;
        server ecommerce-service-2:4001;
    }

    upstream elearning_services {
        server elearning-service-1:4002;
        server elearning-service-2:4002;
    }

    upstream fooddelivery_services {
        server fooddelivery-service-1:4003;
        server fooddelivery-service-2:4003;
    }

    upstream healthcare_services {
        server healthcare-service-1:4004;
        server healthcare-service-2:4004;
    }

    upstream travel_services {
        server travel-service-1:4005;
        server travel-service-2:4005;
    }

    upstream wholesale_services {
        server wholesale-service-1:4006;
        server wholesale-service-2:4006;
    }

    server {
        listen 80;
        server_name localhost;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Main platform
        location / {
            proxy_pass http://main_platform;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Shop routing based on region
        location /shop/us-east {
            proxy_pass http://shops_us_east;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /shop/us-west {
            proxy_pass http://shops_us_west;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /shop/eu {
            proxy_pass http://shops_eu;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /shop/asia {
            proxy_pass http://shops_asia;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Industry service routing
        location /services/ecommerce {
            proxy_pass http://ecommerce_services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/elearning {
            proxy_pass http://elearning_services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/fooddelivery {
            proxy_pass http://fooddelivery_services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/healthcare {
            proxy_pass http://healthcare_services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/travel {
            proxy_pass http://travel_services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/wholesale {
            proxy_pass http://wholesale_services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
